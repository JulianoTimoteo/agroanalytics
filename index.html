<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>üå±AgroAnalytics - Dashboard Operacional</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#050A14"> 
    <meta name="apple-mobile-web-app-title" content="AgroAnalytics">
    
    <!-- CORRE√á√ÉO 1: Caminho relativo ./ para o manifesto -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- √çcone do Navegador -->
    <link rel="icon" type="image/x-icon" href="https://usinapitangueiras.com.br/wp-content/uploads/2020/10/cropped-favicon-180x180.png">
    
    <!-- CORRE√á√ÉO 2: √çcone do iPhone usando o link direto (j√° que o arquivo local pode n√£o existir) -->
    <link rel="apple-touch-icon" href="https://usinapitangueiras.com.br/wp-content/uploads/2020/10/cropped-favicon-180x180.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
     <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyADUuqh_THzGInTSytxzUFEwHV5LmwdvYc",
            authDomain: "agroanalytics-api.firebaseapp.com",
            projectId: "agroanalytics-api",
            storageBucket: "agroanalytics-api.firebasestorage.app",
            messagingSenderId: "739888244342",
            appId: "1:739888244342:web:558d620583469ec515e157",
            measurementId: "G-6TYZDXMJZ5"
        };

        // Inicializa o Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>
    
    <!-- CORRE√á√ÉO 3: Caminho relativo ./ para o CSS -->
    <link rel="stylesheet" href="./style.css"> 
    
    <!-- Estilo Inline para o Checkbox de Login -->
    <style>
        .checkbox-container {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-bottom: 15px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .checkbox-container input {
            width: auto !important;
            margin-right: 8px !important;
            margin-bottom: 0 !important;
        }
    </style>
</head>
<body>
    <div id="user-settings-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="window.agriculturalDashboard.closeModal('user-settings-modal')" aria-label="Fechar"><i class="fas fa-times"></i></button>
            <h3 id="modal-title">Configura√ß√µes de Conta</h3>
            
            <div id="modal-alert-message" class="alert-success-login hidden margin-bottom-10"></div>
            
            <form id="update-password-form">
                <p class="text-secondary margin-bottom-15">Atualize sua senha. O email de redefini√ß√£o ser√° enviado para a sua conta atual.</p>
                <input type="password" id="current-password" placeholder="Senha Atual (Obrigat√≥rio para Confirma√ß√£o)" required autocomplete="current-password">
                <input type="password" id="new-password" placeholder="Nova Senha (M√≠n. 6 caracteres)" required autocomplete="new-password">
                <input type="password" id="confirm-new-password" placeholder="Confirme a Nova Senha" required autocomplete="new-password">
                <button type="submit" class="btn-primary margin-bottom-10">
                    <i class="fas fa-key"></i> Salvar Nova Senha
                </button>
                <p class="text-secondary modal-footer-text">
                    Para alterar o e-mail, entre em contato com o administrador.
                </p>
            </form>
        </div>
    </div>

    <div id="admin-user-modal" class="modal-overlay">
        <div class="modal-content modal-content-medium">
            <button class="close-btn" onclick="window.agriculturalDashboard.closeModal('admin-user-modal')" aria-label="Fechar"><i class="fas fa-times"></i></button>
            <h3><i class="fas fa-user-shield"></i> Gerenciar Usu√°rio</h3>
            
            <form id="admin-user-form">
                <input type="hidden" id="admin-user-id"> <div class="input-group-row margin-bottom-10">
                    <input type="text" id="admin-user-nickname" placeholder="Apelido (Login)" required style="width: 100%;">
                </div>
                
                <div class="input-group-row margin-bottom-10">
                    <input type="password" id="admin-user-password" placeholder="Senha (Deixe em branco para manter)" style="width: 100%;">
                </div>

                <div class="permissions-container margin-bottom-15">
                    <p class="text-secondary" style="margin-bottom: 5px;"><strong>Permiss√µes de Acesso:</strong></p>
                    <div class="checkbox-grid">
                        <label><input type="checkbox" name="perm" value="tab-moagem"> Moagem</label>
                        <label><input type="checkbox" name="perm" value="tab-alertas"> Alertas</label>
                        <label><input type="checkbox" name="perm" value="tab-caminhao"> Caminh√µes</label>
                        <label><input type="checkbox" name="perm" value="tab-equipamento"> Colheita</label>
                        <label><input type="checkbox" name="perm" value="tab-frentes"> Frentes</label>
                        <label><input type="checkbox" name="perm" value="tab-metas"> Metas</label>
                        <label><input type="checkbox" name="perm" value="tab-horaria"> Entrega HxH</label>
                        <label><input type="checkbox" name="perm" value="tab-gerenciar"> Gerenciar (Admin)</label>
                    </div>
                </div>

                <button type="submit" class="btn-primary">
                    <i class="fas fa-save"></i> Salvar Usu√°rio
                </button>
            </form>
        </div>
    </div>

    <div id="login-screen" class="full-screen-overlay">
        <div class="login-container">
            <h1>AgroAnalytics</h1>
            <p>Acesse o painel com suas credenciais</p>
            <div id="auth-error" class="alert-danger hidden"></div>
            <div id="auth-success" class="alert-success-login hidden"></div>

            <form id="login-form">
                <input type="text" id="login-user" placeholder="Apelido ou E-mail" required autocomplete="username">
                <input type="password" id="login-password" placeholder="Senha" required autocomplete="current-password">
                
                <!-- üî• NOVO: CHECKBOX MANTER CONECTADO -->
                <div class="checkbox-container">
                    <input type="checkbox" id="remember-me" checked>
                    <label for="remember-me" style="cursor: pointer;">Manter conectado</label>
                </div>

                <div class="login-actions">
                    <button type="submit" class="btn-primary">Entrar</button>
                </div>
                
                <a href="#" id="forgot-password-link" class="btn-forgot">Esqueceu a senha? Redefinir</a>
                
                <p>N√£o tem conta? <a href="#" id="show-signup">Solicitar Cadastro</a></p>
            </form>

            <form id="signup-form" class="hidden">
                <p>Preencha os dados abaixo para solicitar seu acesso. Responderemos em at√© 24h.</p>
                <input type="text" id="signup-name" placeholder="Nome Completo / Apelido" required autocomplete="name">
                <input type="email" id="signup-email" placeholder="E-mail (para recupera√ß√£o)" required autocomplete="email">
                <input type="tel" id="signup-phone" placeholder="Telefone/WhatsApp" required autocomplete="tel">
                <button type="submit" class="btn-primary">Solicitar Cadastro</button>
                <p>J√° tem conta? <a href="#" id="show-login">Fazer Login</a></p>
            </form>
        </div>
    </div>

    <div id="main-dashboard" class="dashboard-layout hidden">
        <div id="loading-overlay" class="hidden">
            <div class="loading-content">
                <div class="loader-wrapper">
                    <div class="loader"></div>
                    <p>Carregando...</p>
                </div>
            </div>
        </div>
        
        <canvas id="particles-js"></canvas> 
        
        <header class="dashboard-header">
            <div class="header-content">
                <button class="menu-toggle-btn" id="menu-toggle-btn" aria-label="Abrir Menu">
                    <i class="fas fa-bars"></i>
                </button>

                <div class="logo">
                    <i class="fas fa-seedling"></i>
                    <h1>AgroAnalytics</h1>
                    <span class="beta-tag">MOAGEM</span>
                </div>
                
                <div class="header-controls">
                    <div class="turno-display-container" id="shiftDisplay">
                        <div class="shift-progress-fill" id="shiftProgressFill"></div>
                        <div class="shift-info-content">
                            <i class="fas fa-clock selector-icon"></i>
                            <span id="shiftName">Calculando...</span>
                            <span id="shiftTimeRemaining" class="shift-timer">0%</span>
                        </div>
                    </div>

                    <div id="lastWeighingDisplayContainer" class="last-weighing-container">
                         <span id="refreshStatusText">Aguardando... üîÑÔ∏è</span>
                         
                         <span id="lastWeighingText" style="display: none;"></span>
                    </div>

                    <button class="btn-cssbuttons">
                        <span><i class="fas fa-ellipsis-h"></i> A√ß√µes</span>
                        <ul>
                            <li>
                                <a href="#" onclick="event.preventDefault(); window.agriculturalDashboard.captureScreenshot()" title="Capturar Tela">
                                    <i class="fas fa-camera"></i>
                                </a>
                            </li>
                            <li>
                                <a href="#" onclick="event.preventDefault(); window.agriculturalDashboard.openModal('user-settings-modal')" title="Configura√ß√µes">
                                    <i class="fas fa-user-cog"></i>
                                </a>
                            </li>
                            <li>
                                <a href="#" onclick="event.preventDefault(); window.agriculturalDashboard.toggleTheme()" title="Alternar Tema">
                                    <i class="fas fa-sun" id="theme-icon"></i>
                                </a>
                            </li>
                            <li>
                                <a href="#" id="logout-btn" title="Sair">
                                    <i class="fas fa-sign-out-alt"></i>
                                </a>
                            </li>
                        </ul>
                    </button>
                </div>
            </div>
        </header>

        <section class="upload-fixed-top" id="uploadSection">
            <div id="lastWeighingDisplayContainer2" class="last-weighing-container">
            </div>
        </section>

        <div id="menu-backdrop"></div>

        <div id="tabs-nav-container" class="tabs-nav-container">
            <nav class="tabs-nav">
                <button class="tab-button active" onclick="window.agriculturalDashboard.showTab('tab-gerenciar')">
                    <i class="fas fa-cogs"></i> Gerenciar
                </button>
                <button class="tab-button" onclick="window.agriculturalDashboard.showTab('tab-moagem')">
                    <i class="fas fa-industry"></i> Moagem
                </button>
                <button class="tab-button" onclick="window.agriculturalDashboard.showTab('tab-alertas')">
                    <i class="fas fa-exclamation-triangle"></i> Alertas
                </button>
                <button class="tab-button" onclick="window.agriculturalDashboard.showTab('tab-caminhao')">
                    <i class="fas fa-truck"></i> Caminh√µes
                </button>
                <button class="tab-button" onclick="window.agriculturalDashboard.showTab('tab-equipamento')">
                    <i class="fas fa-tractor"></i> Colheita
                </button>
                <button class="tab-button" onclick="window.agriculturalDashboard.showTab('tab-frentes')">
                    <i class="fas fa-map-marked-alt"></i> Frentes
                </button>
                <button class="tab-button" onclick="window.agriculturalDashboard.showTab('tab-metas')">
                    <i class="fas fa-bullseye"></i> Metas
                </button>
                <button class="tab-button" onclick="window.agriculturalDashboard.showTab('tab-horaria')">
                    <i class="fas fa-clock"></i> Entrega HxH
                </button>
                <button class="tab-button" onclick="window.agriculturalDashboard.showTab('tab-usuarios')">
                    <i class="fas fa-user-lock"></i> Usu√°rios
                </button>
            </nav>
        </div>
        <main class="dashboard-main">
            <div class="main-content-layout"> 
            
                <section class="analytics-container"> 
                    
                    <div class="tabs-content">
                        
                        <div id="tab-gerenciar" class="tab-pane active">
                            <div class="analytics-row">
                                <div class="analytics-card glass-card full-width hover-zoom-card">
                                    <div class="card-header">
                                        <h3><i class="fas fa-tv"></i> Modo Apresenta√ß√£o (TV/Quiosque)</h3>
                                    </div>
                                    <div class="presentation-controls" style="display: flex; align-items: center; gap: 20px; padding: 10px;">
                                        <div class="input-group-row" style="flex: 0 0 auto;">
                                            <label for="presentation-timer">Tempo por Slide (seg):</label>
                                            <input type="number" id="presentation-timer" value="30" min="5" style="width: 80px; text-align: center; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); color: var(--text); padding: 5px; border-radius: 4px;">
                                        </div>
                                        <button class="btn-primary" onclick="window.agriculturalDashboard.togglePresentation()">
                                            <i class="fas fa-play"></i> INICIAR APRESENTA√á√ÉO
                                        </button>
                                        <p class="text-secondary" style="margin: 0;">
                                            <i class="fas fa-info-circle"></i> Pressione <strong>ESC</strong> para sair do modo tela cheia.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div class="analytics-row">
                                <div class="analytics-card glass-card half-width hover-zoom-card">
                                    <div class="card-header">
                                        <h3><i class="fas fa-upload"></i> Carregamento de Dados</h3>
                                    </div>
                                    
                                    <div class="dropzone-card glass-card upload-highlight" id="dropzoneCard"> 
                                        <label for="fileInput" class="sr-only">Upload de Arquivo</label>
                                        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" 
                                            multiple webkitdirectory directory hidden>
                                        
                                        <div class="dropzone-content">
                                            <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                            <p class="drop-text">Arraste e Solte seus arquivos ou pastas aqui</p>
                                            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                                                <i class="fas fa-file-import"></i> 
                                                Selecionar Arquivo
                                            </button>
                                        </div>
                                        <div class="file-info-compact" id="fileInfo">Aguardando arquivo...</div>
                                    </div>
    
                                    <div class="info-section upload-info-section"> 
                                        <h4>Instru√ß√µes:</h4>
                                        <p>Arraste e solte <strong>m√∫ltiplos arquivos</strong> ou uma <strong>pasta inteira</strong>
                                            na √°rea acima, ou utilize o bot√£o 'Selecionar Arquivo'.</p>
                                        <p>Formatos aceitos: Excel (.xlsx, .xls) e CSV</p>
                                        <p class="upload-warning-text">
                                            Aguarde a mensagem de "Arquivos carregados" ou "Falha no carregamento"
                                            antes de interagir com as outras abas.
                                        </p>
                                    </div>
                                </div>
                                
                                <div class="analytics-card glass-card half-width hover-zoom-card">
                                    <div class="card-header">
                                        <h3><i class="fas fa-clipboard-list"></i> Relat√≥rios de Configura√ß√£o</h3>
                                    </div>
                                    <div class="mini-list">
                                        <p>Status de Conex√£o: <span class="success-color-bold">ATIVO</span></p>
                                        <p>Usu√°rio: <span id="current-user-email" class="primary-color">-</span></p>
                                        <p>√öltima Configura√ß√£o: <span class="primary-color">v1.3.0 - 2025-12-18</span></p>
                                        <p><button class="btn-action" onclick="alert('Baixando Log de Eventos.')">Baixar Log</button></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="tab-usuarios" class="tab-pane">
                            <div class="sub-tabs-nav">
                                <button class="tab-button active" onclick="window.agriculturalDashboard.showSubTab('subtab-gerenciar-acesso', this)">
                                    <i class="fas fa-users-cog"></i> Gerenciar Acesso
                                </button>
                                <button class="tab-button" onclick="window.agriculturalDashboard.showSubTab('subtab-solicitacoes', this)">
                                    <i class="fas fa-bell"></i> Solicita√ß√µes (<span id="requests-count">0</span>)
                                </button>
                                </div>
                            
                            <div class="tabs-content-sub">
                                <div id="subtab-gerenciar-acesso" class="tab-pane-sub active">
                                    <div class="analytics-row">
                                        <div class="analytics-card glass-card full-width hover-zoom-card">
                                            <div class="card-header">
                                                <h3><i class="fas fa-user-lock"></i> Gest√£o de Usu√°rios (Login por Apelido)</h3>
                                                <button class="btn-primary" onclick="window.agriculturalDashboard.openUserModal()">
                                                    <i class="fas fa-plus"></i> Novo Usu√°rio
                                                </button>
                                            </div>
                                            <div id="user-management-container" class="meta-table-wrapper">
                                                <p>Carregando dados de usu√°rios...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div id="subtab-solicitacoes" class="tab-pane-sub">
                                    <div class="analytics-row">
                                        <div class="analytics-card glass-card full-width hover-zoom-card">
                                            <div class="card-header">
                                                <h3><i class="fas fa-user-plus"></i> Solicita√ß√µes Pendentes de Cadastro</h3>
                                            </div>
                                            <div id="registration-requests-container" class="meta-table-wrapper">
                                                <p>Nenhuma solicita√ß√£o pendente.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="tab-moagem" class="tab-pane">
                            <div class="kpi-fixed-top-moagem">
                                <div class="glass-card stat-card-mini" id="cardAcumuladoSafra">
                                    <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                                    <div class="stat-info">
                                        <span class="stat-value" id="acumuladoSafra">0 ton</span>
                                        <span class="stat-label">Acumulado Safra</span>
                                        <div class="stat-sub-info">
                                            <span class="text-secondary" style="font-size: 0.8rem;">
                                                Desde o in√≠cio da safra
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div class="glass-card stat-card-mini" id="cardViagens">
                                    <div class="stat-icon"><i class="fas fa-route"></i></div>
                                    <div class="stat-info">
                                        <span class="stat-value" id="totalViagens">0</span>
                                        <span class="stat-label">Frota</span>
                                        <div class="stat-sub-info">
                                            <span class="sub-stat green" title="Pr√≥pria">
                                                <span id="viagensProprias">0</span> Pr√≥
                                            </span>
                                            <span class="separator">|</span>
                                            <span class="sub-stat orange" title="Terceiros">
                                                <span id="viagensTerceiros">0</span> Terc
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div class="glass-card stat-card-mini analysis-card" id="statAnalise">
                                    <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                                    <div class="stat-info">
                                        <span class="stat-value" id="taxaAnalise">0%</span>
                                        <span class="stat-label">Analisadas</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="analytics-row fleet-status-row">
                                <div class="analytics-card glass-card full-width hover-zoom-card" id="cardStatusFrota">
                                    <div class="card-header">
                                        <h3><i class="fas fa-truck-moving"></i> Status da Frota</h3>
                                    </div>
                                    <div class="fleet-status-grid" id="fleetStatusCardsGrid"></div>
                                </div>
                            </div>
                            
                            <div class="analytics-row">
                                <div class="analytics-card glass-card half-width hover-zoom-card">
                                    <div class="card-header">
                                        <div class="header-title-with-tooltip">
                                            <h3><i class="fas fa-chart-bar"></i> Acumulado & Progresso</h3>
                                            <div class="tooltip-container">
                                                <i class="fas fa-info-circle info icon"></i>
                                                <div class="tooltip-text">Acompanhamento do progresso da Moagem em rela√ß√£o √† meta di√°ria configurada.</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="moagem-control-panel">
                                        <div class="acumulado-display">
                                            <div class="acumulado-header">
                                                <span class="acumulado-label">Acumulado do Dia</span>
                                                <span class="acumulado-value" id="moagemAcumulado">0 t</span>
                                            </div>
                                            <div class="progress-container">
                                                <div class="progress-bar" id="moagemProgressBar"></div>
                                            </div>
                                            <div class="progress-stats">
                                                <span id="moagemPerc">0%</span> da Meta (<span id="moagemTargetDisplay">25000 t</span>)
                                            </div>
                                        </div>
                                        <div class="meta-setting-rodape-moagem">
                                            <div class="meta-item-rodape">
                                                <label for="metaMoagemInput">Meta Moagem (t/h):</label>
                                                <input type="number" id="metaMoagemInput" value="25000" class="moagem-input-discreto" onchange="window.agriculturalDashboard.saveMeta(this.value, 'metaMoagem')">
                                            </div>
                                            <div class="meta-item-rodape">
                                                <label for="metaRotacaoInput">Meta Rota√ß√£o (RPM):</label>
                                                <input type="number" id="metaRotacaoInput" value="1100" class="moagem-input-discreto" onchange="window.agriculturalDashboard.saveMeta(this.value, 'metaRotacao')">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="analytics-card glass-card half-width hover-zoom-card">
                                    <div class="card-header">
                                        <div class="header-title-with-tooltip">
                                            <h3><i class="fas fa-chart-line"></i> Proje√ß√£o De Moagem</h3>
                                            <div class="tooltip-container">
                                                <i class="fas fa-info-circle icon"></i>
                                                <div class="tooltip-text">Estima se a meta ser√° atingida com base no ritmo atual.</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="forecast-panel">
                                        <div class="forecast-main">
                                            <span class="forecast-label">Previs√£o 24h</span>
                                            <div class="forecast-value-group">
                                                <span class="forecast-value-big" id="moagemForecast">0 t</span>
                                                <span class="forecast-diff" id="forecastDifferenceContainer"></span> 
                                            </div>
                                            <span class="forecast-badge" id="moagemStatus">Calculando...</span>
                                            <div class="owner-distribution-container" id="ownerDistributionBarContainer"></div>
                                            <div class="ritmo-medio-info" id="ritmoAtualFormulaContainer"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="analytics-row">
                                <div class="analytics-card glass-card full-width hover-zoom-card">
                                    <div class="card-header">
                                        <div class="header-title-with-tooltip">
                                            <h3><i class="fas fa-chart-bar"></i> Vis√£o Hor√°ria Detalhada</h3>
                                            <div class="tooltip-container">
                                                <i class="fas fa-info-circle icon"></i>
                                                <div class="tooltip-text">Visualiza√ß√£o detalhada do ritmo de moagem (Real, Potencial e Rota√ß√£o) de hora em hora.</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="carousel-container wide" id="hourlyCarouselContainer">
                                        <div class="carousel-slide active">
                                            <div class="chart-container-title primary-color">Moagem(t/h)</div>
                                            <div class="chart-container wide"><canvas id="realHourlyChart"></canvas></div>
                                        </div>
                                        <div class="carousel-slide">
                                            <div class="chart-container-title potencial-color">Potencial(t/h)</div>
                                            <div class="chart-container wide"><canvas id="potencialHourlyChart"></canvas></div>
                                        </div>
                                        <div class="carousel-slide">
                                            <div class="chart-container-title rotacao-color">Rota√ß√£o(RPM)</div>
                                            <div class="chart-container wide"><canvas id="rotacaoHourlyChart"></canvas></div>
                                        </div>
                                        
                                        <button class="carousel-nav prev-btn" aria-label="Gr√°fico Anterior"><i class="fas fa-chevron-left"></i></button>
                                        <button class="carousel-nav next-btn" aria-label="Pr√≥ximo Gr√°fico"><i class="fas fa-chevron-right"></i></button>
                                        
                                        <div class="carousel-indicators" id="carouselIndicators">
                                            <span class="indicator active" onclick="window.agriculturalDashboard.showSlide(0)" aria-label="Ir para Gr√°fico 1"></span>
                                            <span class="indicator" onclick="window.agriculturalDashboard.showSlide(1)" aria-label="Ir para Gr√°fico 2"></span>
                                            <span class="indicator" onclick="window.agriculturalDashboard.showSlide(2)" aria-label="Ir para Gr√°fico 3"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="tab-alertas" class="tab-pane">
                            <div class="analytics-row">
                                <div class="analytics-card glass-card full-width">
                                    <div class="card-header">
                                        <div class="header-title-with-tooltip">
                                            <h3><i class="fas fa-check-circle"></i> Alertas de Conformidade</h3>
                                            <div class="tooltip-container">
                                                <i class="fas fa-info-circle icon"></i>
                                                <div class="tooltip-text">Inconsist√™ncias encontradas nos dados (Pesos, Duplicidades).</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="alert-list" id="alertsContainer"></div>
                                </div>
                            </div>
                        </div>

                        <div id="tab-caminhao" class="tab-pane">
                            <div class="analytics-row">
                                <div class="analytics-card glass-card full-width hover-zoom-card">
                                    <div class="card-header">
                                        <div class="header-title-with-tooltip">
                                            <h3><i class="fas fa-chart-bar"></i> Entrega Hor√°ria (Pr√≥pria vs Terceiros)</h3>
                                            <div class="tooltip-container">
                                                <i class="fas fa-info-circle icon"></i>
                                                <div class="tooltip-text">Distribui√ß√£o hor√°ria de peso entre frota pr√≥pria e terceiros (Ciclo 06:00 - 05:59). Passe o mouse sobre as barras para ver os percentuais.</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="chart-container wide"><canvas id="fleetHourlyChartInCaminhoes"></canvas></div>
                                </div>
                            </div>
                            <div class="analytics-row">
                                <div class="analytics-card glass-card half-width hover-zoom-card min-height-400">
                                    <div class="card-header">
                                        <div class="header-title-with-tooltip">
                                            <h3><i class="fas fa-trophy"></i> Top 5 Caminh√µes</h3>
                                            <div class="tooltip-container">
                                                <i class="fas fa-info-circle icon"></i>
                                                <div class="tooltip-text">Ranking das frotas com maior volume transportado.</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="top-list-container side-by-side">
                                        <div class="top-list-section" id="topFrotasPropriasContainer">
                                            <h4>Pr√≥prias</h4>
                                            <div class="top-list" id="topFrotasProprias"></div>
                                        </div>
                                        <div class="top-list-section" id="topFrotasTerceirosContainer">
                                            <h4>Terceiros</h4>
                                            <div class="top-list" id="topFrotasTerceiros"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="analytics-card glass-card half-width hover-zoom-card min-height-400">
                                    <div class="card-header">
                                        <div class="header-title-with-tooltip">
                                            <h3><i class="fas fa-chart-pie"></i> Distribui√ß√£o de Peso</h3>
                                            <div class="tooltip-container">
                                                <i class="fas fa-info-circle icon"></i>
                                                <div class="tooltip-text">Propor√ß√£o entre frota pr√≥pria e terceirizada.</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="chart-container"><canvas id="fleetChart"></canvas></div>
                                </div>
                            </div>
                        </div>

                        <div id="tab-equipamento" class="tab-pane">
                            <div class="analytics-row">
                                <div class="analytics-card glass-card half-width hover-zoom-card">
                                    <div class="card-header">
                                        <div class="header-title-with-tooltip">
                                            <h3><i class="fas fa-tractor"></i> Top 5 Colheita</h3>
                                            <div class="tooltip-container">
                                                <i class="fas fa-info-circle icon"></i>
                                                <div class="tooltip-text">Equipamentos de colheita mais produtivos.</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="top-list-container side-by-side">
                                        <div class="top-list-section">
                                            <h4>Pr√≥prias</h4>
                                            <div class="top-list" id="topEquipamentosProprios"></div>
                                        </div>
                                        <div class="top-list-section">
                                            <h4>Terceiros</h4>
                                            <div class="top-list" id="topEquipamentosTerceiros"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="analytics-card glass-card half-width hover-zoom-card">
                                    <div class="card-header">
                                        <div class="header-title-with-tooltip">
                                            <h3><i class="fas fa-chart-pie"></i> Produtividade Colheita</h3>
                                            <div class="tooltip-container">
                                                <i class="fas fa-info-circle icon"></i>
                                                <div class="tooltip-text">Participa√ß√£o de cada grupo de colhedoras no total.</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="chart-container"><canvas id="harvestChart"></canvas></div>
                                </div>
                            </div>
                            <div class="analytics-row">
                                <div class="analytics-card glass-card full-width hover-zoom-card">
                                    <div class="card-header">
                                        <div class="header-title-with-tooltip">
                                            <h3><i class="fas fa-users"></i> Operadores e Transbordos</h3>
                                            <div class="tooltip-container">
                                                <i class="fas fa-info-circle icon"></i>
                                                <div class="tooltip-text">Desempenho individual de operadores e transbordos.</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="top-list-container side-by-side">
                                        <div class="top-list-section">
                                            <h4>Operadores de Colheita Pr√≥pria</h4>
                                            <div class="top-list" id="topOperadoresColheitaPropria"></div>
                                        </div>
                                        <div class="top-list-section">
                                            <h4>Transbordos Terceiros</h4>
                                            <div class="top-list" id="topTransbordos"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="tab-frentes" class="tab-pane">
                            <div class="analytics-row">
                                <div class="analytics-card glass-card full-width">
                                    <div class="card-header">
                                        <div class="header-title-with-tooltip">
                                            <h3><i class="fas fa-map-pin"></i> Vis√£o por Frente de Trabalho</h3>
                                            <div class="tooltip-container">
                                                <i class="fas fa-info-circle icon"></i>
                                                <div class="tooltip-text">
                                                    <strong>Regra de Ranking:</strong><br>
                                                    1¬∫ Maior Ton Total<br>
                                                    2¬∫ Menor N¬∫ Viagens<br>
                                                    3¬∫ Melhor Ton/Viagem<br>
                                                    4¬∫ Maior N¬∫ An√°lises
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="fronts-grid" id="frontsGrid"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="tab-metas" class="tab-pane">
                            </div>

                        <div id="tab-horaria" class="tab-pane">
                            <div class="analytics-row">
                                <div class="analytics-card glass-card full-width hover-zoom-card">
                                    <div class="card-header">
                                        <div class="header-title-with-tooltip">
                                            <h3><i class="fas fa-clock"></i> Viagens e An√°lise por Hora</h3>
                                            <div class="tooltip-container">
                                                <i class="fas fa-info-circle icon"></i>
                                                <div class="tooltip-text">Fluxo de viagens e taxa de an√°lise ao longo do dia.</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="chart-container wide"><canvas id="timeChart"></canvas></div>
                                </div>
                            </div>
                            <div class="analytics-row">
                                <div class="analytics-card glass-card full-width hover-zoom-card">
                                    <div class="card-header">
                                        <div class="header-title-with-tooltip">
                                            <h3><i class="fas fa-calendar-alt"></i> Entrega de Peso por Frente</h3>
                                            <div class="tooltip-container">
                                                <i class="fas fa-info-circle icon"></i>
                                                <div class="tooltip-text">Volume hor√°rio entregue por cada frente.</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="chart-container wide"><canvas id="frontHourlyChart"></canvas></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
        
        <footer class="dashboard-footer"></footer>
    </div>
    
    <!-- CORRE√á√ÉO 4: Caminhos relativos ./ em todos os scripts JS -->
    <script src="./utils.js"></script>
    <script src="./intelligent-processor.js"></script>
    
    <script src="./data-analyzer-kpis.js"></script>
    <script src="./data-analyzer-rankings.js"></script>
    <script src="./data-analyzer-time.js"></script>
    <script src="./data-analyzer-metas.js"></script> 
    <script src="./dataanalyzer.js"></script> 

    <script src="./datavalidator.js"></script>

    <script src="./visualizer-kpis.js"></script>
    <script src="./visualizer-charts-base.js"></script>
    <script src="./visualizer-charts-moagem.js"></script>
    <script src="./visualizer-grid.js"></script>
    <script src="./visualizer-metas.js"></script> 
    <script src="./datavisualizer.js"></script>

    <script src="./app.js"></script>
    
    <script src="./mobile-fixes.js"></script>

    <script>
        // Sistema de autentica√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            const loginScreen = document.getElementById('login-screen');
            const mainDashboard = document.getElementById('main-dashboard');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const showSignupLink = document.getElementById('show-signup');
            const showLoginLink = document.getElementById('show-login');
            const authError = document.getElementById('auth-error');
            const logoutBtn = document.getElementById('logout-btn');
            const currentUserEmail = document.getElementById('current-user-email');
            
            // --- INICIALIZA√á√ÉO DO APP COM OS NOVOS LISTENERS ---
            if (typeof window.agriculturalDashboard !== 'undefined') {
                window.agriculturalDashboard.initializeEventListeners();
            }

            // Verifica se o usu√°rio j√° est√° logado (mantido para fallback)
            auth.onAuthStateChanged((user) => {
                if (user) {
                    loginScreen.classList.add('hidden');
                    mainDashboard.classList.remove('hidden');
                    // üî• CORRE√á√ÉO: Mostra Apelido se dispon√≠vel
                    if(user.displayName) {
                        currentUserEmail.textContent = user.displayName;
                    } else {
                        // Tenta remover o sufixo de dom√≠nio interno se for um login por apelido
                        let display = user.email;
                        if(display.includes('@agro.local')) {
                            display = display.split('@')[0];
                        }
                        currentUserEmail.textContent = display;
                    }
                    
                } else {
                    mainDashboard.classList.add('hidden');
                    loginScreen.classList.remove('hidden');
                }
            });

            // Login (REDIRECIONADO PARA APP.JS)
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const userIdentifier = document.getElementById('login-user').value;
                const password = document.getElementById('login-password').value;
                
                if (typeof window.agriculturalDashboard !== 'undefined' && window.agriculturalDashboard.handleLogin) {
                    window.agriculturalDashboard.handleLogin(e); 
                    return;
                }

                // Fallback (apenas para email)
                auth.signInWithEmailAndPassword(userIdentifier, password)
                    .then((userCredential) => {
                        authError.classList.add('hidden');
                        loginForm.reset();
                    })
                    .catch((error) => {
                        authError.textContent = error.message;
                        authError.classList.remove('hidden');
                    });
            });

            // Cadastro (REDIRECIONADO PARA APP.JS)
            signupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (typeof window.agriculturalDashboard !== 'undefined' && window.agriculturalDashboard.handleSignup) {
                    window.agriculturalDashboard.handleSignup(e);
                } else {
                    authError.textContent = "Erro: O sistema de cadastro n√£o est√° pronto. Tente novamente mais tarde.";
                    authError.classList.remove('hidden');
                }
            });


            // Alternar entre login e cadastro
            showSignupLink.addEventListener('click', (e) => {
                e.preventDefault();
                authError.classList.add('hidden'); // Oculta erro ao trocar
                document.getElementById('auth-success').classList.add('hidden');
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
            });

            showLoginLink.addEventListener('click', (e) => {
                e.preventDefault();
                authError.classList.add('hidden'); // Oculta erro ao trocar
                document.getElementById('auth-success').classList.add('hidden');
                signupForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            });

            // Redefinir Senha (Esqueceu a senha) - REDIRECIONADO PARA APP.JS
            const forgotPasswordLink = document.getElementById('forgot-password-link');
            if (forgotPasswordLink) {
                 forgotPasswordLink.addEventListener('click', (e) => {
                     e.preventDefault();
                     if (typeof window.agriculturalDashboard !== 'undefined' && window.agriculturalDashboard.handleForgotPassword) {
                         window.agriculturalDashboard.handleForgotPassword(e);
                     }
                 });
            }


            // Logout (mantido o fallback para compatibilidade inicial do HTML)
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    auth.signOut().catch((error) => {
                        console.error('Erro ao fazer logout:', error);
                    });
                });
            }

        });
    </script>
</body>
</html>